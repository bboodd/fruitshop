<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.shop.fruitshop.admin.AdminMapper">

<!--    findById   -->
    <select id="findById" resultType="com.shop.fruitshop.domain.Admin">
        SELECT *
        FROM admin
        WHERE id = #{id} AND password = #{password}
    </select>

<!--    상품 등록   -->
    <insert id="addProduct">
        INSERT INTO product (category_id, name, price, discount_rate, stock_quantity, content)
        VALUES ((SELECT id FROM category WHERE category_name = #{categoryName}),
                #{name}, #{price}, #{discountRate}, #{stockQuantity}, #{content})
    </insert>

<!--    상품 이미지 등록   -->
    <insert id="addProductImage">
        INSERT INTO product_image (product_id, origin_name, file_name, file_size)
        VALUES ((SELECT id FROM product WHERE name = #{name}),
                #{originName}, #{fileName}, #{fileSize})
    </insert>

<!--    상품 상태에 따른 개수 조회   -->
    <select id="countStatusAll" resultType="java.util.Map">
        SELECT
            SUM(CASE WHEN status IN (1, 2, 3) THEN 1 ELSE 0 END) AS total_count,
            SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) AS status_1_count,
            SUM(CASE WHEN status = 2 THEN 1 ELSE 0 END) AS status_2_count,
            SUM(CASE WHEN status = 3 THEN 1 ELSE 0 END) AS status_3_count
        FROM
            product
    </select>

<!--    선택 상품 개수 조회   -->
    <select id="countProducts" resultType="int">

        SELECT COUNT(*) AS total_count
        FROM product product
        JOIN category category ON product.category_id = category.id
        <where>
            <if test="selectedStatus != ''">
                AND product.status = #{selectedStatus}
            </if>
            <if test="selectedCategory != ''">
                AND category_name = #{selectedCategory}
            </if>
            <if test="searchKeyword != ''">
                AND product.name LIKE CONCAT('%', #{searchKeyword}, '%')
            </if>
        </where>
    </select>

<!--    전체 상품 리스트 조회   -->
    <select id="selectProductAll" resultType="java.util.Map">
        SELECT
            product.id,
            CASE product.status
                WHEN 1 THEN '판매중'
                WHEN 2 THEN '판매중지'
                WHEN 3 THEN '품절'
                END AS status,
            product.name,
            product.price,
            product.discount_rate,
            DATE_FORMAT(product.created_at, '%Y-%m-%d') AS created_at,
            DATE_FORMAT(product.updated_at, '%Y-%m-%d') AS updated_at,
            category.category_name
        FROM product product
                 JOIN category category
                      ON product.category_id = category.id
        WHERE product.status = 1 or product.status = 2 or product.status = 3
        ORDER BY product.id DESC
            LIMIT 10
    </select>

<!--    선택 상품 리스트 조회   -->
    <select id="selectProductList" resultType="java.util.Map">
        SELECT
            product.id,
            CASE product.status
                WHEN 1 THEN '판매중'
                WHEN 2 THEN '판매중지'
                WHEN 3 THEN '품절'
                END AS status,
            product.name,
            product.price,
            product.discount_rate,
            DATE_FORMAT(product.created_at, '%Y-%m-%d') AS created_at,
            DATE_FORMAT(product.updated_at, '%Y-%m-%d') AS updated_at,
            category.category_name
        FROM product product
                 JOIN category category
                      ON product.category_id = category.id
        <where>
            <if test="selectedStatus != ''">
                product.status = #{selectedStatus}
            </if>
            <if test="selectedCategory != ''">
                AND category_name = #{selectedCategory}
            </if>
            <if test="searchKeyword != ''">
                AND product.name LIKE CONCAT('%', #{searchKeyword}, '%')
            </if>

        </where>
        ORDER BY product.id DESC
        <if test="selectedTab != ''">
            LIMIT #{selectedTab}
        </if>
    </select>


    <update id="saleStopOne">
        UPDATE product
        SET status = 2
        WHERE id = #{selectedStopId}
    </update>

    <update id="saleStopMany">
        UPDATE product
        SET status = 2
        WHERE id IN
        <foreach collection="selectedStopIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <update id="productDeleteMany">
        UPDATE product
        SET status = 4
        WHERE id IN
        <foreach collection="selectedDeleteIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>


</mapper>